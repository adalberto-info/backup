-- 03/10/2019 - ADALBERTO (WAFX) - MODASP-2413 - 03.19.000 - SCRIPT CRIA CAMPOS ICMS-RESSARCIMENTO. 

------------------------
-- TABELA ENTRADAS_IMPOSTO - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ENTRADAS_IMPOSTO' AND COLUMN_NAME = 'BASE_ICMS_SUBSTITUTO')
	BEGIN
		ALTER TABLE [DBO].[ENTRADAS_IMPOSTO] ADD [BASE_ICMS_SUBSTITUTO] [numeric] (14, 2) NULL
	END;

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ENTRADAS_IMPOSTO' AND COLUMN_NAME = 'ALIQUOTA')
	BEGIN
		ALTER TABLE [DBO].[ENTRADAS_IMPOSTO] ADD [ALIQUOTA] [numeric] (8, 5) NULL
	END;

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ENTRADAS_IMPOSTO' AND COLUMN_NAME = 'ICMS_PRESUMIDO')
	BEGIN
		ALTER TABLE [DBO].[ENTRADAS_IMPOSTO] ADD [ICMS_PRESUMIDO] [numeric] (8, 5) NULL
	END;

------------------------
-- TABELA ENTRADAS_ITEM - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ENTRADAS_ITEM' AND COLUMN_NAME = 'CHAVE_NFE_SUBSTITUTO')
	BEGIN
		ALTER TABLE [DBO].[ENTRADAS_ITEM] ADD [CHAVE_NFE_SUBSTITUTO] [VARCHAR] (44) NULL
	END;

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ENTRADAS_ITEM' AND COLUMN_NAME = 'SEQ_ITEM_SUBSTITUTO')
	BEGIN
		ALTER TABLE [DBO].[ENTRADAS_ITEM] ADD [SEQ_ITEM_SUBSTITUTO] [CHAR] (4) NULL
	END;

------------------------
-- TABELA PRODUTOS_UF_ICMS - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'PRODUTOS_UF_ICMS' AND COLUMN_NAME = 'IS_ICMS_SUBSTITUTO')
	BEGIN
		ALTER TABLE [DBO].[PRODUTOS_UF_ICMS] ADD [IS_ICMS_SUBSTITUTO] [BIT] NOT NULL DEFAULT 0
	END;

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'PRODUTOS_UF_ICMS' AND COLUMN_NAME = 'ALIQUOTA_FECP')
	BEGIN
		ALTER TABLE [DBO].[PRODUTOS_UF_ICMS] ADD [ALIQUOTA_FECP] [NUMERIC] (8,5) NOT 
	END;

------------------------
-- TABELA MATERIAIS_UF_ICMS - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'MATERIAIS_UF_ICMS' AND COLUMN_NAME = 'IS_ICMS_SUBSTITUTO')
	BEGIN
		ALTER TABLE [DBO].[MATERIAIS_UF_ICMS] ADD [IS_ICMS_SUBSTITUTO] [BIT] NOT NULL DEFAULT 0
	END;

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'MATERIAIS_UF_ICMS' AND COLUMN_NAME = 'ALIQUOTA_FECP')
	BEGIN
		ALTER TABLE [DBO].[MATERIAIS_UF_ICMS] ADD [ALIQUOTA_FECP] [NUMERIC] (8,5) NULL 
	END;

------------------------
-- TABELA DADOS_FECHAMENTO_RESSARCIMENTO - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'DADOS_FECHAMENTO_RESSARCIMENTO')
	BEGIN
		
		CREATE TABLE [dbo].[DADOS_FECHAMENTO_RESSARCIMENTO](
		[COD_FECHAMENTO] [char](8) NOT NULL,
		[DESC_FECHAMENTO] [varchar](40) NOT NULL,
		[ID_EXERCICIO] [INT] NULL,
		[ID_PERIODO] [INT]  NULL,
		[DATA_INICIAL] [DATETIME] NULL,
		[DATA_FINAL] [DATETIME] NULL,
		[UTILIZA_SALDO_ANTERIOR] [BIT] NOT NULL DEFAULT 0,
		[COD_FECHAMENTO_ANTERIOR] [CHAR] (8),
		[DATA_GERACAO] [DATETIME] NULL,
		[RESPONSAVEL] [VARCHAR](25)
		CONSTRAINT [PK_DADOS_FECHAMENTO_RESSARCIMENTO] PRIMARY KEY CLUSTERED 
		(
		[COD_FECHAMENTO] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]
		) ON [PRIMARY]

	END;

------------------------
-- TABELA CONTROLE_ENT_RESSARCIMENTO - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'CONTROLE_ENT_RESSARCIMENTO')
	BEGIN
		
		CREATE TABLE [dbo].[CONTROLE_ENT_RESSARCIMENTO](
		[COD_FECHAMENTO] [char](8) NOT NULL DEFAULT '',
		[ID] [INT] IDENTITY(1,1),
		[EMPRESA] [INT] NULL ,
		[COD_FILIAL] [char](06) NOT NULL DEFAULT '',
		[FILIAL] [varchar](25)  NULL ,
		[NOME_CLIFOR] [varchar](25) NULL ,
		[NF_ENTRADA] [char](15) NOT NULL DEFAULT '',
		[SERIE_NF] [varchar](6) NOT NULL DEFAULT '' ,
		[CHAVE_NFE] [varchar](44) NULL,
		[RECEBIMENTO] [datetime] NULL,
		[VALOR_TOTAL] [numeric](14,2) NULL,
		[ITEM] [char](12) NOT NULL DEFAULT '',
		[COR_ITEM] [char](10) NOT NULL DEFAULT '',
		[TAMANHO] [varchar](8) NOT NULL DEFAULT '',
		[QTDE_ENTRADA] [numeric](9,3) NULL ,
		[ALIQUOTA] [numeric](8,5) NULL ,
		[BASE_ICMS_ST] [numeric](14,2)  NULL ,
		[ICMS_EFETIVO] [numeric](14,2) NULL ,
		[ICMS_PRESUMIDO] [numeric](14,2)  NULL ,
		[BASE_ICMS_PRESUMIDO] [numeric](14,2)  NULL ,
		[VALOR_ISENTO] [numeric](14,2) NULL,
		[SEQ_ITEM_SUBTITUTO] [char](4) NULL ,
		[CHAVE_NFE_SUBSTITUTO] [varchar](44) NULL,
		[CODIGO_FISCAL_OPERACAO] [char](4) NULL ,
		[NATUREZA] [char](15) NULL ,
		[SALDO_NF_ENTRADA] [numeric](9,3) NULL,
		[REFERENCIA] [varchar](50) NULL,
		[DESCRICAO_ITEM] [varchar](80) NULL,
		[NUMERO_MODELO_FISCAL] [varchar](03) NULL,
		CONSTRAINT [PK_CONTROLE_ENT_RESSARCIMENTO] PRIMARY KEY CLUSTERED 
		(
			[COD_FECHAMENTO] ASC, 
			[COD_FILIAL] ASC,
			[NF_ENTRADA] ASC,
			[SERIE_NF] ASC,
			[ITEM] ASC,
			[TAMANHO] ASC,
			[COR_ITEM] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]
		) ON [PRIMARY]

	END;


------------------------
-- TABELA CONTROLE_SAI_RESSARCIMENTO - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'CONTROLE_SAI_RESSARCIMENTO')
	BEGIN
		
		CREATE TABLE [dbo].[CONTROLE_SAI_RESSARCIMENTO](
		[COD_FECHAMENTO] [char](8) NOT NULL DEFAULT '',
		[ID] [INT] IDENTITY(1,1),
		[EMPRESA] [INT] NULL ,
		[COD_FILIAL] [char](06) NOT NULL DEFAULT '',
		[FILIAL] [varchar](25)  NULL,
		[NOME_CLIFOR] [varchar](25) NULL ,
		[NF_SAIDA] [char](15) NOT NULL DEFAULT '' ,
		[SERIE_NF] [varchar](6) NOT NULL DEFAULT '',
		[EMISSAO] [datetime] NULL ,
		[CHAVE_NFE] [varchar](44) NULL,
		[VALOR_TOTAL] [numeric](14,2) NULL ,
		[ITEM] [char](12) NOT NULL DEFAULT '' ,
		[COR_ITEM] [char](10) NULL,
		[TAMANHO] [varchar](8) NOT NULL DEFAULT '' ,
		[QTDE_VENDIDA] [numeric](9,3) NULL ,
		[ALIQUOTA] [numeric](8,5) NULL ,
		[BASE_ICMS_ST] [numeric](14,2) NULL ,
		[ICMS_EFETIVO] [numeric](14,2) NULL ,
		[BASE_ICMS_PRESUMIDO] [numeric](14,2) NULL ,
		[VALOR_ISENTO] [numeric](14,2) NULL,
		[INDICA_CONSUMIDOR_FINAL] [bit]  NULL ,
		[CODIGO_FISCAL_OPERACAO] [char](4) NULL,
        [NF_ENTRADA_RELACIONADA] [char](15) NOT NULL DEFAULT '' ,
		[SERIE_NF_RELACIONADA] [varchar](6) NOT NULL DEFAULT '',
		[NOME_CLIFOR_RELACIONADA] [varchar](25) NOT NULL DEFAULT '',
		[RECEBIMENTO_RELACIONADA] [datetime] NULL,
		[QTDE] [numeric](9,3) NOT NULL DEFAULT 0,
		[ICMS_PRESUMIDO] [numeric](14,2) NULL ,
		[CHAVE_NFE_SUBSTITUTO] [varchar](44) NULL,
		[SEQ_ITEM_SUBSTITUTO] [char](4) NULL ,
		[UNIDADE] [varchar](05) NULL,
		[PRECO_UNITARIO] [numeric](15,5) NULL,
		[DESCRICAO_ITEM] [varchar](80) NULL,
		[NUMERO_MODELO_FISCAL] [varchar](03) NULL,
		[TIPO_REMETENTE] [numeric](2) NULL,
		[ALIQUOTA_ST] [numeric](8,5) NULL,
		[ITEM_IMPRESSAO] [char](4) NOT NULL DEFAULT '',
		CONSTRAINT [PK_CONTROLE_SAI_RESSARCIMENTO] PRIMARY KEY CLUSTERED 
		(
			[COD_FECHAMENTO] ASC,
			[COD_FILIAL] ASC,
			[NF_SAIDA] ASC,
			[SERIE_NF] ASC,
			[ITEM] ASC,
			[TAMANHO] ASC,
			[ITEM_IMPRESSAO] ASC,
			[NF_ENTRADA_RELACIONADA] ASC,
			[SERIE_NF_RELACIONADA] ASC,
			[NOME_CLIFOR_RELACIONADA] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]
		) ON [PRIMARY]

	END;


------------------------
-- TABELA CONTROLE_SALDO_RESSARCIMENTO - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'CONTROLE_SALDO_RESSARCIMENTO')
	BEGIN
		
		CREATE TABLE [dbo].[CONTROLE_SALDO_RESSARCIMENTO](
		[FILIAL] [varchar](25)  NOT NULL DEFAULT '',
		[COD_FECHAMENTO] [char](8) NOT NULL DEFAULT '',
		[ITEM] [char](12) NOT NULL DEFAULT '',
		[ESTOQUE_INICIAL] [numeric](9,3) NULL,
		[ESTOQUE_FINAL] [numeric](9,3) NULL,
		[QTDE_MOV] [numeric](9,3)  NULL ,
		[ICMS_EFETIVO] [numeric](14,2)  NULL ,
		[ICMS_PRESUMIDO] [numeric](14,2) NULL ,
		[COMPL_REST] [numeric](15,5) NULL,
		[TOTAL] [numeric](15,5) NULL,
		CONSTRAINT [PK_CONTROLE_SALDO_RESSARCIMENTO] PRIMARY KEY CLUSTERED 
		(
		FILIAL, COD_FECHAMENTO, ITEM ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]
		) ON [PRIMARY]

	END;


------------------------
-- TABELA RESSARCIMENTO_FILIAIS - 
------------------------
IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'RESSARCIMENTO_FILIAIS')
	BEGIN
		
		CREATE TABLE [dbo].[RESSARCIMENTO_FILIAIS](
		[COD_FECHAMENTO] [CHAR](8) NOT NULL DEFAULT '',
		[COD_FILIAL] [CHAR](6)  NOT NULL DEFAULT '',
		[FILIAL] [VARCHAR](25) NULL ,
		[MATRIZ_FISCAL] [VARCHAR](25) NULL,
		[SEL_MATRIZ_FISCAL] [BIT] NOT NULL DEFAULT 0,
		[VAREJISTA] [BIT] NOT NULL DEFAULT 0
		CONSTRAINT [PK_RESSARCIMENTO_FILIAIS] PRIMARY KEY CLUSTERED 
		(
		COD_FECHAMENTO, COD_FILIAL  ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
        ) ON [PRIMARY]

		ALTER TABLE [dbo].[RESSARCIMENTO_FILIAIS]  WITH NOCHECK ADD  CONSTRAINT [01_RESSARCIMENTO_FILIAIS] FOREIGN KEY([COD_FECHAMENTO])
		REFERENCES [dbo].[DADOS_FECHAMENTO_RESSARCIMENTO] ([COD_FECHAMENTO])
		ON DELETE CASCADE
		NOT FOR REPLICATION 

		ALTER TABLE [dbo].[RESSARCIMENTO_FILIAIS] CHECK CONSTRAINT [01_RESSARCIMENTO_FILIAIS]

		ALTER TABLE [dbo].[RESSARCIMENTO_FILIAIS]  WITH NOCHECK ADD  CONSTRAINT [02_RESSARCIMENTO_FILIAIS] FOREIGN KEY([COD_FILIAL])
		REFERENCES [dbo].[FILIAIS] ([COD_FILIAL])
		ON DELETE CASCADE
		NOT FOR REPLICATION 

		ALTER TABLE [dbo].[RESSARCIMENTO_FILIAIS] CHECK CONSTRAINT [02_RESSARCIMENTO_FILIAIS]


	END;


------------------------
-- TABELA FECHAMENTO_RESSARCIMENTO_ERRO - 
------------------------

IF NOT EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'FECHAMENTO_RESSARCIMENTO_ERRO')
	BEGIN

	CREATE TABLE [dbo].[FECHAMENTO_RESSARCIMENTO_ERRO](
		[COD_FECHAMENTO] [char](8) NOT NULL,
		[DATA] [datetime] NOT NULL,
		[ERRO] [varchar](max) NOT NULL) 

	ALTER TABLE [dbo].[FECHAMENTO_RESSARCIMENTO_ERRO]  WITH NOCHECK ADD  CONSTRAINT [FK01_FECHAMENTO_RESSARCIMENTO_ERRO] FOREIGN KEY([COD_FECHAMENTO])
	REFERENCES [dbo].[DADOS_FECHAMENTO_RESSARCIMENTO] ([COD_FECHAMENTO])
	ON DELETE CASCADE


	END;